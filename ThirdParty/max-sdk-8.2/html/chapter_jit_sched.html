<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Max API: Scheduler and Low Priority Queue Issues</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Max API
   &#160;<span id="projectnumber">8.2.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('chapter_jit_sched.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Scheduler and Low Priority Queue Issues </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In Max, there are a few threads of execution.</p>
<p>The details of these threads are highlighted in the Max documentation and the article, "Event Priority in Max (Scheduler vs. Queue)". In this chapter, we won't cover all these details and restrict our discussion to the scheduler (which when overdrive is on runs in a separate and high priority thread) and the low priority queue (which always runs in the main application thread). As far as Jitter is concerned, we won't consider the real time audio thread or the case of scheduler in audio interrupt, where the scheduler runs in this real time audio thread.</p>
<p>By default, Jitter performs all drawing and matrix processing in the main application thread, with events serviced from the low priority queue. The reason for this low priority processing is to prevent high timing events such as note triggering or audio DSP from suffering timing problems due to visual processing. Jitter also exploits the low priority queue as a mechanism for graceful temporal downsampling of the visual stream in the instance that the processing requested is too demanding to be calculated in real-time. This results in dropped frames in the output when the demands cant be met. With audio, it's not sufficient to just drop frames of samples, since there will be an audible click, but with images, the last image will persist if a new one isn't generated at some fixed sampling rate.</p>
<h1><a class="anchor" id="chapter_jit_sched_usurp"></a>
Defer and Usurp</h1>
<p>The mechanisms which enforce execution of Jitter drawing and matrix processing from within the low priority queue we will call "defer" and "usurp". The defer mechanism will take any high priority events and create a corresponding low priority event at the end of the low priority queue. The defer mechanism ensures that the events will not be executed from the high priority scheduler thread, but does not prevent scheduler backlog with the temporal downsampling mentioned above. To accomplish this, the usurp mechanism mush be used. The usurp mechanism will use no more than one low priority queue element for the task requested (either a method call or attribute setter). The way usurp works is that if there is no pending event for the method or attribute call, a new event is placed at the end of the low priority queue. If there is already an event pending, the usurp mechanism will not place a new event on the end of the low priority queue, but rather "usurp" the arguments for the event waiting to being passed to the method or attribute call. This way, if a high priority metronome is rapidly sending values to set an attribute, while the initial low priority event is waiting to be processed, the value to be set is constantly being updated ("usurped") and only the value at the time of servicing the event will be used.</p>
<p>It is important to note that the defer and usurp mechanisms only work as called from within the Max patcher. For any methods which are called from a text based programming language, such as C, Java, or JavaScript, the defer and usurp mechanisms are bypassed. This may be something you need to pay attention to and handle yourself if you are making such calls from a text based programming language and need the defer or usurp behavior.</p>
<h1><a class="anchor" id="chapter_jit_sched_using"></a>
Using Defer and Usurp in Jitter Object Methods</h1>
<p>When defining a method in Jitter, there is the possibility to define a type signature for the method just as one would do in Max. Typical type signatures include typical atom elements such as <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a002f28879581a6f66ea492b994b96f1e" title="long integer">A_LONG</a>, <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a0b3aa0ab8104573dfc9cb70b5b08031f" title="32-bit float">A_FLOAT</a>, and <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a2d661c2a5d949566e2f1944c99bceeea" title="t_symbol pointer">A_SYM</a>; or the corresponding default value versions <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a7bd979db3dcf86909e24a1d1452e2205" title="long but defaults to zero">A_DEFLONG</a>, <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a42b644240dcbb90fe67282a4d0688776" title="float, but defaults to zero">A_DEFFLOAT</a>, <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47aa010616276cb89bcd04bcba611e18d51" title="symbol, defaults to &quot;&quot;">A_DEFSYM</a>; or the variable argument version <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a81c1a8550f038db16a619167a70a79b6" title="request that args be passed as an array, the routine will check the types itself.">A_GIMME</a> which provides a list of atoms and the number of atoms provided; or the private and untyped status of <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47af48193ec36e53b1507d81c49873c8d7a" title="cannot typecheck args">A_CANT</a> used for methods which are not exposed to the patcher and require additional C function prototype information in order to call. While these type signatures can be used within Jitter objects, most methods exposed to the patcher interface make use of either the defer or usurp mechanism as defined by two new type signatures <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a4556bc5fe0d4f8cc55eda5aeeee55cf2" title="A special signature for declaring methods. This is like A_GIMME, but the call is deferref to the back...">A_DEFER_LOW</a> or <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a8c844b0a1b551341a6a5e3b95d2f1152" title="A special signature for declaring methods. This is like A_GIMME, but the call is deferred to the back...">A_USURP_LOW</a>. Methods defined with the <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a4556bc5fe0d4f8cc55eda5aeeee55cf2" title="A special signature for declaring methods. This is like A_GIMME, but the call is deferref to the back...">A_DEFER_LOW</a>, or <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a8c844b0a1b551341a6a5e3b95d2f1152" title="A special signature for declaring methods. This is like A_GIMME, but the call is deferred to the back...">A_USURP_LOW</a> type signatures should conform to the same variable argument prototype as <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a81c1a8550f038db16a619167a70a79b6" title="request that args be passed as an array, the routine will check the types itself.">A_GIMME</a> methods, but behind the scenes, Jitter will make use of the defer and usurp mechanism to enforce the appropriate behavior.</p>
<p>An example of two methods from jit.gl.videoplane which use these mechanisms is below:</p>
<div class="fragment"><div class="line"><span class="comment">// add a usurping jit_matrix method</span></div>
<div class="line"><a class="code" href="group__classmod.html#ga3d3fb6b5f0696ac552b1b810a1656a73">jit_class_addmethod</a>(_jit_gl_videoplane_class, (<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)jit_gl_videoplane_jit_matrix,   <span class="stringliteral">&quot;jit_matrix&quot;</span>, <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a8c844b0a1b551341a6a5e3b95d2f1152">A_USURP_LOW</a>, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// add a deferred sendtexture method</span></div>
<div class="line"><a class="code" href="group__classmod.html#ga3d3fb6b5f0696ac552b1b810a1656a73">jit_class_addmethod</a>(_jit_gl_videoplane_class, (<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)jit_gl_videoplane_sendtexture,   <span class="stringliteral">&quot;sendtexture&quot;</span>,  <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a4556bc5fe0d4f8cc55eda5aeeee55cf2">A_DEFER_LOW</a>, 0);</div>
<div class="line"> </div>
<div class="line">The implementation of these methods is below:</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> jit_gl_videoplane_jit_matrix(t_jit_gl_videoplane *x, <a class="code" href="structt__symbol.html">t_symbol</a> *s, <span class="keywordtype">int</span> argc, <a class="code" href="structt__atom.html">t_atom</a> *argv)</div>
<div class="line">{</div>
<div class="line">   <a class="code" href="structt__symbol.html">t_symbol</a> *name;</div>
<div class="line">   <span class="keywordtype">void</span> *m;</div>
<div class="line">   <a class="code" href="structt__jit__matrix__info.html">t_jit_matrix_info</a> info;</div>
<div class="line">   <span class="keywordtype">long</span> dim[2];</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">if</span> ((name=<a class="code" href="group__atommod.html#ga73b81472812e4c5475d07d9914d84f89">jit_atom_getsym</a>(argv)) != <a class="code" href="group__jitter.html#gae1fd77934399ea2966d50728ed8144c2">_jit_sym_nothing</a>) {</div>
<div class="line">      m = <a class="code" href="group__objectmod.html#ga328c0beb469f32437b756852fe8583bf">jit_object_findregistered</a>(name);</div>
<div class="line">      <span class="keywordflow">if</span> (!m) {</div>
<div class="line">         <a class="code" href="group__console.html#ga8a87d2e25431900a88722759ec115757">error</a>(<span class="stringliteral">&quot;jit.gl.videoplane: couldn&#39;t get matrix object!&quot;</span>);</div>
<div class="line">         <span class="keywordflow">return</span>;</div>
<div class="line">      }</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">if</span> (x-&gt;texture) {</div>
<div class="line">      jit_object_method(m, <a class="code" href="group__jitter.html#gaa54d88c62f83bcde09d3e819f5cedf65">_jit_sym_getinfo</a>, &amp;info);</div>
<div class="line">      <a class="code" href="group__attrmod.html#gac22c2370ca40b23c110321f2b3af3d89">jit_attr_getlong_array</a>(x-&gt;texture,<a class="code" href="group__jitter.html#gae59203825989a640817bad4d5b0961dd">_jit_sym_dim</a>,2,dim);</div>
<div class="line">      jit_object_method(x-&gt;texture,s,s,argc,argv);</div>
<div class="line">      <a class="code" href="group__attrmod.html#ga94cb0362d0ea100cdda79dd04abea5b3">jit_attr_setsym</a>(x,ps_texture,x-&gt;texturename);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> jit_gl_videoplane_sendtexture(t_jit_gl_videoplane *x, <a class="code" href="structt__symbol.html">t_symbol</a> *s, <span class="keywordtype">int</span> argc, <a class="code" href="structt__atom.html">t_atom</a> *argv)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordflow">if</span> (x-&gt;texture) {</div>
<div class="line">      s = <a class="code" href="group__atommod.html#ga73b81472812e4c5475d07d9914d84f89">jit_atom_getsym</a>(argv);</div>
<div class="line">      argc--;</div>
<div class="line">      <span class="keywordflow">if</span> (argc)</div>
<div class="line">         argv++;</div>
<div class="line">      <span class="keywordflow">else</span></div>
<div class="line">         argv = NULL;</div>
<div class="line">      <a class="code" href="group__obj.html#ga443dee482af22e0fe83e68955d367226">object_method_typed</a>(x-&gt;texture,s,argc,argv,NULL);</div>
<div class="line">   }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__atom_html_gga8aa6700e9f00b132eb376db6e39ade47a4556bc5fe0d4f8cc55eda5aeeee55cf2"><div class="ttname"><a href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a4556bc5fe0d4f8cc55eda5aeeee55cf2">A_DEFER_LOW</a></div><div class="ttdeci">@ A_DEFER_LOW</div><div class="ttdoc">A special signature for declaring methods. This is like A_GIMME, but the call is deferref to the back...</div><div class="ttdef"><b>Definition:</b> ext_mess.h:296</div></div>
<div class="ttc" id="agroup__atom_html_gga8aa6700e9f00b132eb376db6e39ade47a8c844b0a1b551341a6a5e3b95d2f1152"><div class="ttname"><a href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a8c844b0a1b551341a6a5e3b95d2f1152">A_USURP_LOW</a></div><div class="ttdeci">@ A_USURP_LOW</div><div class="ttdoc">A special signature for declaring methods. This is like A_GIMME, but the call is deferred to the back...</div><div class="ttdef"><b>Definition:</b> ext_mess.h:297</div></div>
<div class="ttc" id="agroup__atommod_html_ga73b81472812e4c5475d07d9914d84f89"><div class="ttname"><a href="group__atommod.html#ga73b81472812e4c5475d07d9914d84f89">jit_atom_getsym</a></div><div class="ttdeci">t_symbol * jit_atom_getsym(t_atom *a)</div><div class="ttdoc">Retrieves atom value as symbol pointer.</div><div class="ttdef"><b>Definition:</b> jit.atom.c:120</div></div>
<div class="ttc" id="agroup__attrmod_html_ga94cb0362d0ea100cdda79dd04abea5b3"><div class="ttname"><a href="group__attrmod.html#ga94cb0362d0ea100cdda79dd04abea5b3">jit_attr_setsym</a></div><div class="ttdeci">t_jit_err jit_attr_setsym(void *x, t_symbol *s, t_symbol *c)</div><div class="ttdoc">Sets attribute value as a symbol value.</div><div class="ttdef"><b>Definition:</b> jit.attribute.util.c:158</div></div>
<div class="ttc" id="agroup__attrmod_html_gac22c2370ca40b23c110321f2b3af3d89"><div class="ttname"><a href="group__attrmod.html#gac22c2370ca40b23c110321f2b3af3d89">jit_attr_getlong_array</a></div><div class="ttdeci">long jit_attr_getlong_array(void *x, t_symbol *s, long max, t_atom_long *vals)</div><div class="ttdoc">Retrieves attribute value as an array of long integer values.</div><div class="ttdef"><b>Definition:</b> jit.attribute.util.c:186</div></div>
<div class="ttc" id="agroup__classmod_html_ga3d3fb6b5f0696ac552b1b810a1656a73"><div class="ttname"><a href="group__classmod.html#ga3d3fb6b5f0696ac552b1b810a1656a73">jit_class_addmethod</a></div><div class="ttdeci">t_jit_err jit_class_addmethod(void *c, method m, const char *name,...)</div><div class="ttdoc">Adds a named method to a class.</div><div class="ttdef"><b>Definition:</b> jit.foundation.c:331</div></div>
<div class="ttc" id="agroup__console_html_ga8a87d2e25431900a88722759ec115757"><div class="ttname"><a href="group__console.html#ga8a87d2e25431900a88722759ec115757">error</a></div><div class="ttdeci">void error(C74_CONST char *fmt,...)</div><div class="ttdoc">Print an error to the Max window.</div></div>
<div class="ttc" id="agroup__datatypes_html_ga482c97424132ea0bcb931d42fca5be78"><div class="ttname"><a href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a></div><div class="ttdeci">BEGIN_USING_C_LINKAGE typedef void *(* method)(void *)</div><div class="ttdoc">Function pointer type for generic methods.</div><div class="ttdef"><b>Definition:</b> ext_mess.h:25</div></div>
<div class="ttc" id="agroup__jitter_html_gaa54d88c62f83bcde09d3e819f5cedf65"><div class="ttname"><a href="group__jitter.html#gaa54d88c62f83bcde09d3e819f5cedf65">_jit_sym_getinfo</a></div><div class="ttdeci">JIT_EX_DATA t_symbol * _jit_sym_getinfo</div><div class="ttdoc">cached t_symbol</div><div class="ttdef"><b>Definition:</b> jit.symbols.h:54</div></div>
<div class="ttc" id="agroup__jitter_html_gae1fd77934399ea2966d50728ed8144c2"><div class="ttname"><a href="group__jitter.html#gae1fd77934399ea2966d50728ed8144c2">_jit_sym_nothing</a></div><div class="ttdeci">JIT_EX_DATA t_symbol * _jit_sym_nothing</div><div class="ttdoc">cached t_symbol</div><div class="ttdef"><b>Definition:</b> jit.symbols.h:16</div></div>
<div class="ttc" id="agroup__jitter_html_gae59203825989a640817bad4d5b0961dd"><div class="ttname"><a href="group__jitter.html#gae59203825989a640817bad4d5b0961dd">_jit_sym_dim</a></div><div class="ttdeci">JIT_EX_DATA t_symbol * _jit_sym_dim</div><div class="ttdoc">cached t_symbol</div><div class="ttdef"><b>Definition:</b> jit.symbols.h:35</div></div>
<div class="ttc" id="agroup__obj_html_ga443dee482af22e0fe83e68955d367226"><div class="ttname"><a href="group__obj.html#ga443dee482af22e0fe83e68955d367226">object_method_typed</a></div><div class="ttdeci">t_max_err object_method_typed(void *x, t_symbol *s, long ac, t_atom *av, t_atom *rv)</div><div class="ttdoc">Sends a type-checked message to an object.</div></div>
<div class="ttc" id="agroup__objectmod_html_ga328c0beb469f32437b756852fe8583bf"><div class="ttname"><a href="group__objectmod.html#ga328c0beb469f32437b756852fe8583bf">jit_object_findregistered</a></div><div class="ttdeci">void * jit_object_findregistered(t_symbol *s)</div><div class="ttdoc">Retrieves a registered object associated with name.</div><div class="ttdef"><b>Definition:</b> jit.foundation.c:1149</div></div>
<div class="ttc" id="astructt__atom_html"><div class="ttname"><a href="structt__atom.html">t_atom</a></div><div class="ttdoc">An atom is a typed datum.</div><div class="ttdef"><b>Definition:</b> ext_mess.h:323</div></div>
<div class="ttc" id="astructt__jit__matrix__info_html"><div class="ttname"><a href="structt__jit__matrix__info.html">t_jit_matrix_info</a></div><div class="ttdoc">Matrix information struct.</div><div class="ttdef"><b>Definition:</b> jit.common.h:116</div></div>
<div class="ttc" id="astructt__symbol_html"><div class="ttname"><a href="structt__symbol.html">t_symbol</a></div><div class="ttdoc">The symbol.</div><div class="ttdef"><b>Definition:</b> ext_mess.h:102</div></div>
</div><!-- fragment --><p>From inspecting the header files, you may note that there are also <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47abcb435e6fecfdcd79276dc8db1988db3" title="A special signature for declaring methods. This is like A_GIMME, but the call is deferred.">A_DEFER</a> and <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47af563cdbe6db453f24552bbe7fe6762d8" title="A special signature for declaring methods. This is like A_GIMME, but the call is deferred and multipl...">A_USURP</a> type signatures, but these should be considered obsolete, as they make use of the problematic deferral strategy of placing the event at the front of the low priority queue and have the potential of reversing message sequencing.</p>
<h1><a class="anchor" id="chapter_jit_sched_attrs"></a>
Using Defer and Usurp in Jitter Object Attributes</h1>
<p>Unlike methods, attributes do not make use of type signatures for their getter and setter accessor methods. Instead they should always be prototyped similar to <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a81c1a8550f038db16a619167a70a79b6" title="request that args be passed as an array, the routine will check the types itself.">A_GIMME</a>, but with an attribute object being passed in place of the traditional method symbol pointer of the <a class="el" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a81c1a8550f038db16a619167a70a79b6" title="request that args be passed as an array, the routine will check the types itself.">A_GIMME</a> signature. So the way you can specify to use the defer and usurp mechanisms for attribute accessors are through the attribute flags argument to the attribute constructor. For the getter accessor method, you can use <a class="el" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a11a88f3db8d39a18143dc2c9ebe81aeb" title="defer getter">JIT_ATTR_GET_DEFER_LOW</a> or <a class="el" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a8da7797b93c643f5371c7fd355a14829" title="usurp getter">JIT_ATTR_GET_USURP_LOW</a> flags. For the setter accessor method, you can use <a class="el" href="group__jitter.html#ga5f72930249b485b67219020c714f6988acbfe492439b20a6b5990136ba4eb96ce" title="defer setter">JIT_ATTR_SET_DEFER_LOW</a> or <a class="el" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a4d69e440bdbfba53ab1f62b6384532d1" title="usurp setter">JIT_ATTR_SET_USURP_LOW</a> flags.</p>
<p>An example attribute definition from jit.gl.videoplane is below:</p>
<div class="fragment"><div class="line">attrflags = <a class="code" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a11a88f3db8d39a18143dc2c9ebe81aeb">JIT_ATTR_GET_DEFER_LOW</a> | <a class="code" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a4d69e440bdbfba53ab1f62b6384532d1">JIT_ATTR_SET_USURP_LOW</a>;</div>
<div class="line">attr = jit_object_new(<a class="code" href="group__jitter.html#gab40fefe3a9e395a661cdc293c1df494a">_jit_sym_jit_attr_offset</a>,<span class="stringliteral">&quot;displaylist&quot;</span>,<a class="code" href="group__jitter.html#ga3a06cf8d41c4f4c017c0bf825fec59f8">_jit_sym_char</a>,attrflags,</div>
<div class="line">   (<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)0L,(<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)jit_gl_videoplane_displaylist,<a class="code" href="group__misc.html#gaad95899dfbc7b5b8fe11921643ef46f0">calcoffset</a>(t_jit_gl_videoplane, displaylist));</div>
<div class="line"><a class="code" href="group__classmod.html#ga37e39db544b4d73596da1557e6c7563a">jit_class_addattr</a>(_jit_gl_videoplane_class,attr);</div>
<div class="ttc" id="agroup__classmod_html_ga37e39db544b4d73596da1557e6c7563a"><div class="ttname"><a href="group__classmod.html#ga37e39db544b4d73596da1557e6c7563a">jit_class_addattr</a></div><div class="ttdeci">t_jit_err jit_class_addattr(void *c, t_jit_object *attr)</div><div class="ttdoc">Adds an attribute to a class.</div><div class="ttdef"><b>Definition:</b> jit.foundation.c:351</div></div>
<div class="ttc" id="agroup__jitter_html_ga3a06cf8d41c4f4c017c0bf825fec59f8"><div class="ttname"><a href="group__jitter.html#ga3a06cf8d41c4f4c017c0bf825fec59f8">_jit_sym_char</a></div><div class="ttdeci">JIT_EX_DATA t_symbol * _jit_sym_char</div><div class="ttdoc">cached t_symbol</div><div class="ttdef"><b>Definition:</b> jit.symbols.h:25</div></div>
<div class="ttc" id="agroup__jitter_html_ga5f72930249b485b67219020c714f6988a11a88f3db8d39a18143dc2c9ebe81aeb"><div class="ttname"><a href="group__jitter.html#ga5f72930249b485b67219020c714f6988a11a88f3db8d39a18143dc2c9ebe81aeb">JIT_ATTR_GET_DEFER_LOW</a></div><div class="ttdeci">@ JIT_ATTR_GET_DEFER_LOW</div><div class="ttdoc">defer getter</div><div class="ttdef"><b>Definition:</b> jit.common.h:45</div></div>
<div class="ttc" id="agroup__jitter_html_ga5f72930249b485b67219020c714f6988a4d69e440bdbfba53ab1f62b6384532d1"><div class="ttname"><a href="group__jitter.html#ga5f72930249b485b67219020c714f6988a4d69e440bdbfba53ab1f62b6384532d1">JIT_ATTR_SET_USURP_LOW</a></div><div class="ttdeci">@ JIT_ATTR_SET_USURP_LOW</div><div class="ttdoc">usurp setter</div><div class="ttdef"><b>Definition:</b> jit.common.h:50</div></div>
<div class="ttc" id="agroup__jitter_html_gab40fefe3a9e395a661cdc293c1df494a"><div class="ttname"><a href="group__jitter.html#gab40fefe3a9e395a661cdc293c1df494a">_jit_sym_jit_attr_offset</a></div><div class="ttdeci">JIT_EX_DATA t_symbol * _jit_sym_jit_attr_offset</div><div class="ttdoc">cached t_symbol</div><div class="ttdef"><b>Definition:</b> jit.symbols.h:47</div></div>
<div class="ttc" id="agroup__misc_html_gaad95899dfbc7b5b8fe11921643ef46f0"><div class="ttname"><a href="group__misc.html#gaad95899dfbc7b5b8fe11921643ef46f0">calcoffset</a></div><div class="ttdeci">#define calcoffset(x, y)</div><div class="ttdoc">Find byte offset of a named member of a struct, relative to the beginning of that struct.</div><div class="ttdef"><b>Definition:</b> ext_prefix.h:143</div></div>
</div><!-- fragment --><p>You may have noticed that like previous code example, all Jitter object attributes which are not private have been defined with getter accessors which use the defer mechanism (<a class="el" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a11a88f3db8d39a18143dc2c9ebe81aeb" title="defer getter">JIT_ATTR_GET_DEFER_LOW</a>) and setter accessors which use the usurp mechanism (<a class="el" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a4d69e440bdbfba53ab1f62b6384532d1" title="usurp setter">JIT_ATTR_SET_USURP_LOW</a>). This is the recommended style of exposing Jitter object attributes to the patcher, since there are many cases where at high priority an attribute is set repeatedly and we want both the latest high priority value when the next calculation is made at low priority and no low priority queue backlog from generating more events at high priority than can be processed at low priority. The defer mechanism is used for getter accessor methods so that every attribute query results in a corresponding output message out the dump outlet. Otherwise certain patcher logic could easily become confused. If a different behavior is required by the Max programmer, they can make use of the jit.qball object to force either the defer or usurp mechanisms to be used for their message stream.</p>
<h1><a class="anchor" id="chapter_jit_sched_wrapper"></a>
Using Defer and Usurp in the Max Wrapper Object</h1>
<p>Most of the above is also true when declaring methods and attributes in the Max wrapper object, however the function calls which are used are slightly different. You must use the special max object function calls <a class="el" href="group__maxwrapmod.html#gac057d2e8d94686363fa9ae8ea0b41fee" title="Adds method to Max class that calls defer_low rather than the method directly.">max_addmethod_defer_low()</a> and <a class="el" href="group__maxwrapmod.html#ga2c596151798123076dcd1d4f7d76e203" title="Adds method to Max class that uses the usurp mechanism to execute method at low priority without back...">max_addmethod_usurp_low()</a> for methods, and <a class="el" href="group__maxwrapmod.html#ga888aa461197db2e7ef2fb0ae34479c3e" title="Adds an attribute to the Max wrapper class.">max_jit_classex_addattr()</a> for attributes. Below are examples from jit.matrixset. Note that there is no type signature provided for either <a class="el" href="group__maxwrapmod.html#gac057d2e8d94686363fa9ae8ea0b41fee" title="Adds method to Max class that calls defer_low rather than the method directly.">max_addmethod_defer_low()</a> or <a class="el" href="group__maxwrapmod.html#ga2c596151798123076dcd1d4f7d76e203" title="Adds method to Max class that uses the usurp mechanism to execute method at low priority without back...">max_addmethod_usurp_low()</a>.</p>
<div class="fragment"><div class="line"><span class="comment">// add a deferred &quot;exportmovie&quot; method</span></div>
<div class="line"><a class="code" href="group__maxwrapmod.html#gac057d2e8d94686363fa9ae8ea0b41fee">max_addmethod_defer_low</a>((<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)max_jit_matrixset_export_movie, <span class="stringliteral">&quot;exportmovie&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// add a usurped outputmatrix method</span></div>
<div class="line"><a class="code" href="group__maxwrapmod.html#ga2c596151798123076dcd1d4f7d76e203">max_addmethod_usurp_low</a>((<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)max_jit_matrixset_outputmatrix,    <span class="stringliteral">&quot;outputmatrix&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// add index attribute</span></div>
<div class="line">attrflags = <a class="code" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a11a88f3db8d39a18143dc2c9ebe81aeb">JIT_ATTR_GET_DEFER_LOW</a> | <a class="code" href="group__jitter.html#ga5f72930249b485b67219020c714f6988a4d69e440bdbfba53ab1f62b6384532d1">JIT_ATTR_SET_USURP_LOW</a> ;</div>
<div class="line">attr = jit_object_new(<a class="code" href="group__jitter.html#gab40fefe3a9e395a661cdc293c1df494a">_jit_sym_jit_attr_offset</a>,<span class="stringliteral">&quot;index&quot;</span>,<a class="code" href="group__jitter.html#gae0e378fee570c930c7000241ed01f90d">_jit_sym_long</a>,attrflags,</div>
<div class="line">      (<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)0L,(<a class="code" href="group__datatypes.html#ga482c97424132ea0bcb931d42fca5be78">method</a>)0L,<a class="code" href="group__misc.html#gaad95899dfbc7b5b8fe11921643ef46f0">calcoffset</a>(t_max_jit_matrixset,index));</div>
<div class="line"><a class="code" href="group__maxwrapmod.html#ga888aa461197db2e7ef2fb0ae34479c3e">max_jit_classex_addattr</a>(p,attr);</div>
<div class="ttc" id="agroup__jitter_html_gae0e378fee570c930c7000241ed01f90d"><div class="ttname"><a href="group__jitter.html#gae0e378fee570c930c7000241ed01f90d">_jit_sym_long</a></div><div class="ttdeci">JIT_EX_DATA t_symbol * _jit_sym_long</div><div class="ttdoc">cached t_symbol</div><div class="ttdef"><b>Definition:</b> jit.symbols.h:26</div></div>
<div class="ttc" id="agroup__maxwrapmod_html_ga2c596151798123076dcd1d4f7d76e203"><div class="ttname"><a href="group__maxwrapmod.html#ga2c596151798123076dcd1d4f7d76e203">max_addmethod_usurp_low</a></div><div class="ttdeci">void max_addmethod_usurp_low(method m, char *s)</div><div class="ttdoc">Adds method to Max class that uses the usurp mechanism to execute method at low priority without back...</div><div class="ttdef"><b>Definition:</b> jit.max.c:1245</div></div>
<div class="ttc" id="agroup__maxwrapmod_html_ga888aa461197db2e7ef2fb0ae34479c3e"><div class="ttname"><a href="group__maxwrapmod.html#ga888aa461197db2e7ef2fb0ae34479c3e">max_jit_classex_addattr</a></div><div class="ttdeci">t_jit_err max_jit_classex_addattr(void *x, void *attr)</div><div class="ttdoc">Adds an attribute to the Max wrapper class.</div><div class="ttdef"><b>Definition:</b> jit.max.c:2084</div></div>
<div class="ttc" id="agroup__maxwrapmod_html_gac057d2e8d94686363fa9ae8ea0b41fee"><div class="ttname"><a href="group__maxwrapmod.html#gac057d2e8d94686363fa9ae8ea0b41fee">max_addmethod_defer_low</a></div><div class="ttdeci">void max_addmethod_defer_low(method m, char *s)</div><div class="ttdoc">Adds method to Max class that calls defer_low rather than the method directly.</div><div class="ttdef"><b>Definition:</b> jit.max.c:1169</div></div>
</div><!-- fragment --><h1><a class="anchor" id="chapter_jit_sched_justsayno"></a>
When Not to Use the Usurp Mechanism</h1>
<p>The bang method for Jitter MOP objects uses the usurp mechanism to drop frames when the number of bang messages cannot be handled in real time. However, jit.gl.render's bang method does not behave this way, and instead uses the defer mechanism. At first this might seem counterintuitive, however, because rendering in OpenGL with jit.gl.render uses a group of messages to perform erasing, any non automatic drawing of objects, and then a drawing of automatic clients and a swap to the screen with the bang method, it is not an atomic action (i.e. requires a sequence of different events rather than a single event). Since the usurp mechanism is method or attribute specific with regard to the events which are being usurped, it only works for atomic actions. For this reason, it is important for users to perform some drop framing behavior before triggering the message sequence, typically accomplished with qmetro or jit.qball. If your object has some operation which requires a sequence of events in a similar fashion as jit.gl.render, then it would be best to use the defer mechanism rather than the usurp mechanism for relevant methods.</p>
<h1><a class="anchor" id="chapter_jit_sched_override"></a>
Overriding Defer and Usurp</h1>
<p>There are instances where the user does not wish to be limited to processing Jitter matrices at low priority, such as when Jitter matrices are used for tasks other than realtime image processing&ndash;for example, parameter interpolation or matrices containing audio data. For these tasks, the jit.qfaker object is provided for advanced users which are aware of the potential problems involved in bypassing these low priority mechanisms. As mentioned above, when programming in a text based language, these mechanisms aren't used and all method and attribute accessor calls are synchronous. Therefore there typically isn't a need to consider overriding this behavior from a text based language. However, for certain externals which wish to simulate the jit.qfaker behavior, we expose the max_jit_queuestate() function to override Jitter's detection of queue state for the defer and usurp mechanisms. It is also possible to query what jitter believes the queue state to be with the max_jit_getqueuestate() function. This is the function employed by the defer and usurp mechanisms. The source code for these functions is below for reference.</p>
<div class="fragment"><div class="line"><span class="keywordtype">long</span> max_jit_queuestate(<span class="keywordtype">long</span> state)</div>
<div class="line">{</div>
<div class="line">   <span class="keywordtype">long</span> rv=_max_jit_queuestate;</div>
<div class="line"> </div>
<div class="line">   _max_jit_queuestate = (state!=0);</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> rv;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">long</span> max_jit_getqueuestate(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">   <span class="comment">// always return true if faking</span></div>
<div class="line">   <span class="keywordflow">if</span> (_max_jit_queuestate) <span class="keywordflow">return</span> 1;</div>
<div class="line"> </div>
<div class="line">   <span class="keywordflow">return</span> !sched_isinpoll();</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
